<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Crop and Create Image for print</title>
  <!-- <link rel="stylesheet" href="vendors/bootstrap/5.3.1/bootstrap.min.css"> -->
  <link rel="stylesheet" href="vendors/cropper/1.6.0/cropper.min.css" />
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
  <style type="text/css">
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      background-color: azure;
      position: relative;
    }

    header,
    footer {
      padding: 20px;
      flex: 0 0 auto;
      background-color: aliceblue;
    }

    main {
      padding: 20px;
      flex: 1 0 auto;
    }

    img {
      width: 100%;
      border: 1px solid gray;
      display: block;
    }

    #cropImageWrapper {
      width: 360px;
      height: 450px;
      display: none;
      visibility: hidden;
    }

    #imageRotateSlider {
      min-width: 360px;
    }

    datalist {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      writing-mode: vertical-lr;
      min-width: 360px;
    }


    #outputCanvas {
      width: 100%;
      box-shadow: 0 0 5px 2px rgba(0, 0, 0, 0.1);
      display: none;
    }

    input,
    button {
      margin-top: 10px;
    }

    input[type="range"] {
      cursor: pointer;
    }
  </style>
</head>

<body>
  <header>
    <!-- crop image -->
    <input type="file" name="imageInput" id="imageInput" accept="image/*" />
    <button id="cropButton" disabled>Crop Image</button>
    <button id="reCropButton" disabled>Re-Crop Image</button>
    <button title="Flip Horizontally" id="flipHorizontallyButton" style="padding-left: 10px; padding-right: 10px;"
      disabled>
      <svg xmlns="http://www.w3.org/2000/svg" style="width: 24px;"
        viewBox="0 0 512 512"><!--! Font Awesome Pro 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
        <path
          d="M406.6 374.6l96-96c12.5-12.5 12.5-32.8 0-45.3l-96-96c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L402.7 224l-293.5 0 41.4-41.4c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-96 96c-12.5 12.5-12.5 32.8 0 45.3l96 96c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 288l293.5 0-41.4 41.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0z" />
      </svg>
    </button>
    <!-- slider -->
    <div>
      <input type="range" name="imageRotateSlider" id="imageRotateSlider" min="-45" max="45" value="0" step="0.001"
        disabled>
      <datalist id="values">
        <option value="-45" label="-45"></option>
        <option value="-30" label="-30"></option>
        <option value="-15" label="-15"></option>
        <option value="0" label="0"></option>
        <option value="15" label="15"></option>
        <option value="30" label="30"></option>
        <option value="45" label="45"></option>
      </datalist>
    </div>
    <!-- canvas grid -->
    <div id="canvasToolGroup">
      <select name="colsSelect" id="colsSelect" disabled>
        <option value="">Select col</option>
        <option value="1">One Col</option>
        <option value="2">Two Cols</option>
        <option value="3">Three Cols</option>
        <option value="4">Four Cols</option>
        <option value="5">Five Cols</option>
        <option selected value="6">Six Cols</option>
        <option value="7">Seven Cols</option>
        <option value="8">Eight Cols</option>
        <option value="9">Nine Cols</option>
        <option value="10">Ten Cols</option>
      </select>

      <select name="rowsSelect" id="rowsSelect" disabled>
        <option value="">Select Row</option>
        <option selected value="1">One Row</option>
        <option value="2">Two Rows</option>
        <option value="3">Three Rows</option>
        <option value="4">Four Rows</option>
        <option value="5">Five Rows</option>
        <option value="6">Six Rows</option>
        <option value="7">Seven Rows</option>
        <option value="8">Eight Rows</option>
        <option value="9">Nine Rows</option>
        <option value="10">Ten Rows</option>
      </select>

      <input type="color" id="backgroundColorInput" disabled />

      <select name="paperSelect" id="paperSelect" disabled>
        <option value="A4" selected>A4</option>
        <option value="_4x6">4x6</option>
        <option value="_5x7">5x7</option>
      </select>

      <div>
        <label style="border: thin solid gray; padding: 2px;" for="isLandscape"><input type="checkbox"
            name="isLandscape" id="isLandscape" disabled>&nbsp;Landscape</label>

        <span id="rotateDegree">Rotate: 0</span>
      </div>

      <button id="downloadImageButton" disabled>Download Image</button>
    </div>
  </header>

  <main>
    <div id="cropImageWrapper">
      <img id="imageForCrop" src="select_picture.png" />
    </div>

    <br />

    <canvas id="outputCanvas">Your browser doesn't support.</canvas>
  </main>

  <footer>&copy; Copyright <a href="http://skwebs.github.io">SK Webs</a>
    <script>document.write(new Date().getFullYear())</script>
  </footer>

  <script src="vendors/cropper/1.6.0/cropper.min.js"></script>
  <script type="text/javascript">

    "use strict";
    // Crop Image Section
    const _ = (e) => document.querySelector(e);
    const cropButton = _("#cropButton");
    const imageForCrop = _("#imageForCrop");
    const reCropButton = _("#reCropButton");
    const cropImageWrapper = _("#cropImageWrapper");
    const outputCanvas = _("#outputCanvas");
    const imageRotateSlider = _("#imageRotateSlider");

    let originalImageMimeType = null;
    let isImageLoaded = false;
    let cropper = null;
    let croppedCanvas = null;

    let targetImageWidth = 360;
    let targetImageHeight = 450;

    // Handle image input change event
    _("#imageInput").addEventListener("change", handleImage);

    reCropButton.addEventListener("click", function () {
      enableCropDisableCanvasTools(true);
    });

    imageRotateSlider.addEventListener("input", function (e) {
      if (cropper) {
        const rotateAngle = e.target.value;
        cropper.rotateTo(rotateAngle);
        _("#rotateDegree").innerText = `Rotate: ${rotateAngle}`;
      }
    });

    let scaleValue = 1;
    const flipHorizontallyButton = _("#flipHorizontallyButton");
    flipHorizontallyButton.addEventListener("click", function () {
      scaleValue = scaleValue !== 1 ? 1 : -1;

      if (cropper) {
        cropper.scaleX(scaleValue)
        // console.log("cropper")
      }
    })

    cropButton.addEventListener("click", cropImage);

    // detect upload image
    function handleImage(event) {
      const file = event.target.files[0];
      if (file) {
        originalImageMimeType = file.type;
        // image onload
        imageForCrop.onload = function () {
          isImageLoaded = true;
          // console.log("image loaded");
          initCropper();
          // cropImageWrapper.style.display = "block";
          enableCropDisableCanvasTools(true);
          // console.log("imageForCrop.onload")
        };
        imageForCrop.src = URL.createObjectURL(file);
      }
    }

    // initialisation of cropper
    function initCropper() {
      if (cropper) {
        destroyCrooper();
      }

      cropper = new Cropper(imageForCrop, {
        viewMode: 3,
        dragMode: "move",
        aspectRatio: 4 / 5,
        autoCropArea: 1,
        restore: !1,
        modal: !1,
        highlight: !1,
        cropBoxMovable: !1,
        cropBoxResizable: !1,
        toggleDragModeOnDblclick: !1,
        ready() {
          cropImageWrapper.style.visibility = "visible";
        },
        crop(event) {
          // console.log(event.detail.rotate);
        },
      });
    }

    function destroyCrooper() {
      cropper.destroy();
      cropper = null;
    }

    function cropImage() {
      if (cropper) {
        croppedCanvas = cropper.getCroppedCanvas({
          width: targetImageWidth,
          height: targetImageHeight,
        });

        if (croppedCanvas !== null) {
          // enable tools
          enableCropDisableCanvasTools(false);
          drawImageGrid();
        }
      }
    }

    function enableCropDisableCanvasTools(statusTrue) {
      document
        .querySelectorAll("#canvasToolGroup>*")
        .forEach((el) => (el.disabled = statusTrue));
      cropButton.disabled = !statusTrue;
      flipHorizontallyButton.disabled = !statusTrue
      isLandscape.disabled = statusTrue
      reCropButton.disabled = statusTrue;
      cropImageWrapper.style.display = statusTrue ? "block" : "none";
      outputCanvas.style.display = statusTrue ? "none" : "block";
      imageRotateSlider.disabled = !statusTrue;
    }




    // =========================== Grid Image Section =====================================================================
    const rowsSelect = _("#rowsSelect");
    const colsSelect = _("#colsSelect");
    const isLandscape = _("#isLandscape");
    isLandscape.addEventListener("click", changeCanvasOrientation);
    const paperSelect = _("#paperSelect");
    paperSelect.addEventListener("change", changePaperSize);

    // Handle background color input change event
    _("#backgroundColorInput").addEventListener("input", setBackgroundColor);
    // Handle rows select change event
    rowsSelect.addEventListener("change", updateGrid);
    // Handle columns select change event
    colsSelect.addEventListener("change", updateGrid);
    // Handle download button click
    const downloadImageButton = _("#downloadImageButton");

    downloadImageButton.addEventListener("click", downloadCanvas);

    let backgroundColor = "#008080"; // Default background color (white)
    // get from user
    let numRows = parseInt(rowsSelect.value, 10) || 1; // Default number of rows
    let numCols = parseInt(colsSelect.value, 10) || 6; // Default number of columns

    let outputCanvasImageBlob = null;


    const photoResolution = 300;
    const screenResolution = 96;
    const scaleFactor = photoResolution / 96;

    const paperSizes = {
      A4: { width: 2480, height: 3505 },
      _4x6: { width: 1200, height: 1800 },
      _5x7: { width: 1500, height: 2100 },
    };
    let paperSize = paperSizes["A4"];

    function changePaperSize(e) {
      paperSize = paperSizes[paperSelect.value];
      // console.log(paperSize);
      changeCanvasOrientation();
      drawImageGrid();
    }

    const ctx = outputCanvas.getContext("2d");
    // default set canvas size
    outputCanvas.width = paperSizes.A4.width;
    outputCanvas.height = paperSizes.A4.height;
    outputCanvas.style.maxWidth = `${paperSize.width / scaleFactor}px`;

    function changeCanvasOrientation(e) {
      // console.log(scaleFactor);
      // console.log(paperSize.height / scaleFactor);
      if (isLandscape.checked) {
        isLandscape.parentElement.style.color = "white";
        isLandscape.parentElement.style.backgroundColor = "darkgreen";
        outputCanvas.width = paperSize.height;
        outputCanvas.height = paperSize.width;
        // set screen max size
        outputCanvas.style.maxWidth = `${paperSize.height / scaleFactor}px`;
        // outputCanvas.style.maxHeight = paperSize.width / scaleFactor;
      } else {
        isLandscape.parentElement.style.color = "black";
        isLandscape.parentElement.style.backgroundColor = "#eee";
        outputCanvas.width = paperSize.width;
        outputCanvas.height = paperSize.height;
        // set screen max size
        outputCanvas.style.maxWidth = `${paperSize.width / scaleFactor}px`;
        // outputCanvas.style.maxHeight = paperSize.height / scaleFactor;
      };
      drawImageGrid();
    }

    // set internally
    let gap = 40; // Adjust gap as needed
    const margin = gap / 2;

    // outputCanvas grid
    function drawImageGrid() {
      if (isImageLoaded) {
        // set background colour white
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);
        // arrange image in rows by for loop
        for (let row = 0; row < numRows; row++) {
          // arrange image in columns by for loop
          for (let col = 0; col < numCols; col++) {
            const x = col * (targetImageWidth + gap) + margin; // Adjusted x position
            const y = row * (targetImageHeight + gap) + margin; // Adjusted y position

            // for maintain original image ratio
            // const y = row * (img.height / img.width * targetImageWidth + gap) + margin; // Adjusted y position

            ctx.fillStyle = backgroundColor;
            ctx.fillRect(x, y, targetImageWidth, targetImageHeight);

            ctx.strokeStyle = "black";
            ctx.lineWidth = 5;

            ctx.drawImage(
              croppedCanvas, x, y, targetImageWidth, targetImageHeight
            );

            ctx.strokeRect(x, y, targetImageWidth, targetImageHeight); // Stroke around the image
          }
        }
      }

      // Store outputCanvas image as Blob
      outputCanvas.toBlob(function (blob) {
        outputCanvasImageBlob = blob;
      }, originalImageMimeType); // Pass original image MIME type
    }


    function setBackgroundColor(event) {
      backgroundColor = event.target.value;
      ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
      drawImageGrid();
    }

    function updateGrid() {
      numRows = parseInt(rowsSelect.value, 10);
      numCols = parseInt(colsSelect.value, 10);
      ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
      drawImageGrid();
    }

    function downloadCanvas() {
      if (outputCanvasImageBlob) {
        const timestamp = new Date().getTime();
        const fileName = `IMG_${timestamp}.png`;
        const link = document.createElement("a");
        link.download = fileName;
        link.href = URL.createObjectURL(outputCanvasImageBlob);
        link.click();
      }
    }

    setBackgroundColor({ target: { value: backgroundColor } });


    _("#imageRotateSlider").addEventListener("input", (event) => {
      console.log(event.target.value)
    });
  </script>
</body>

</html>
